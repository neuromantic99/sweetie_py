
# Kohl lab pipeline for processing suite2p imaging data and pyControl behaviour  

## What is this repository for?

* To process multiple raw PyControl txt and binary files into a organised matlab structure
* To align behaviour during 2P imaging with matlab structures outputted by Suite-2p
* present imaging data and aligned behaviour in a single organised matlab structure

## Requirements

* Matlab 2017b or later

## Usage

* Download all matlab functions and ensure they are in matlab's path
* Set the paths in the pipeline function as detailed in the comments. Essentially pointing to where your 
suite-2p structures and raw pycontrol files are held
* Suite 2p files should be stored using the default output file structure of suite2p - mouse>date>area>plane. See https://github.com/cortex-lab/Suite2P
* The pipeline takes an arugment 'mouse' this should be the ID of the mouse whose data structure you wish to generate. (See next section).
* The pipeline will save two structures, one containing just behaviour and one containing imaging aligned with behaviour. The save location is dictated by the savePath variables in the pipeline.
* Each pyControl task will have different variables of interest. These currently need to be updated in teh getTasks.m function. 

### Mouse IDs
* The mouse arugment to the pipeline function should be identical to the mouse_name varibale in suite2p
* In pyControl for pure behaviour, the Subject ID should be identical to the suite2p and pipeline mouse name variables
* When using pyControl for imaging the Subject ID should be in the format mousename_areaxx. Where xx is the area number in the format 01, 02, 03 ...
* If the task has a TTL variable corresponding to the start and end of imaging, imaging can be started and stopped multiple times for the same area without stopping pyControl or 
changing the Subject ID. If the objective is moved, the area number should be updated as above.


## Data format in imaging structure:

### Behavioural data (session_behaviour)

The timestamps of all behavioural data is normalised to the start of the imaging and has the unit of FRAMES.
So the timestamp refers to the imaging frame at which the behavioural event occured.

#### Operant tasks

* ID: The name of the mouse on MCMS
* date: The date of the imaging
* area: The area number that the behaviour and imaging was recorded at
* task: the pyControl task
* licks: The frames that a lick event was registered 
* water_delivered: The frames that a water reward was delivered
* motor_start: The frame that the motor started moving forwards. This is used as the signal to create trial by trial information
* motor_atWhisk: The frame that the motor arrived at the whiskers
* motor_back: The frame that the motor started back from the whiskers
* motor_atOrigin: The frame that the motor arrived back at the origin
* TTLs: The frames that 2P triggering TTLs arrived at pyControl. h=Has dimensionality [2 x num_recordings]. Row 1 is TTLin, row 2 in TTLout. 
* velocity: The mean speed of the rotary encoder within each frame 
* trialType: This list is where information about the trial outcome (e.g. correct_trial) should be read from. It is an ordered list of trial outcomes, ordered in the same way as motor_start and trialByTrialFlu. So trialType(1) shows the outcome of the trial initiated by motor_start(1) and recorded as trialByTrialFlu(1,:,:). The first 1-3 trials should be called 'initial'. This is where the animal does not have to induce the trial by running and is automatically rewarded regardless of behaviour.

#### Sensory Stimulation

Same as above, but without trialType and licks and the addition of:
* stim_position: the position the pole was moved to
* stim_speed: the speed of the pole


### Imaging data (planeN)

The result of the 2p imaging generated by suite2p, containing the following fields:

* raw_fluoresence: a 1x1 cell containing a matrix of dimensionality (nROIS x nFrames). This does not take into account work on the GUI, so many of the ROIs may not be cells. Contains the fluoresence signal before neuropil subtraction and DFoF.
* raw_neuropil: same as above, but the fluoresence signal from the neuropil surrounding the ROI.
* spike_timings: Contains only ROI selected as cells in the GUI (refered to herein as units). A cell of dimensionality (nUnits x 1). Each index of the cell contains a matrix of dimensionality (nSpikes x 1). Each item in these matrices is the frame that a spike occured in that given unit.
* spike_amps: same as above, but the amplitude of the corresponding spike
* fluoresence_corrected: a matrix of dimensionality (nUnits x nFrames). Contains the corrected fluoresence signal (neuropil subtracted from each unit at each frame.
* position: a matrix of dimensionality (nUnits x 2). The xy coordinates of each unit.
* is_red: whether or not each unit also gives a signal in the red channel (if present)
* fRate: the frame rate at planeN
* trialByTrialFlu: a matrix of dimensionality (nTrials x nUnits x nFrames). The same as fluoresence_corrected but now split by trial. Currently a trial is 4 seconds long. Beginning 1 second before the onset of whisker stimulation and ending 3 seconds after whisker stimualtion. The trial length and offset from whisker stim can be set using the variables tBefore and tAfter in the function 'timeSeries.m'.  
* trialByTrialSpikes: a cell of dimensionality (nUnits x nTrials). Each item in the cell is a matrix containing the frame in which a spike occured in each trial. Times are normalised to the start of a trial so all spike times range between 0 and the number of frames in a trial.
* trialBytrialAmps: as above but the amplitudes of corresponding spikes.
* info: a note to keep Friedemann sane

## ToDo

* Currently, adding a new task involves delving into a loop within the tasks.m function. Adding a new task should be available to someone who isn't me
* The pyControl should take the frame clock as an input and the alignment should be done with this instead of the mean frame rate. This may utilise packio
* There's at least 5 comments saying something along the lines of: 'this is really bad change this' these should be dealt with.
















































