
# Kohl lab pipeline for processing suite2p imaging data and pyControl behaviour  

The code requires the pyControl data_import.py module availble at: https://bitbucket.org/takam/pycontrol/src/default/tools/data_import.py?fileviewer=file-view-default

This is imported as readPyControl in workflow_behav.

To use the pipeline, first run workflow_behav setting the file paths as detailed in the comments.

Next run the matlab function 'pipeline' giving a mouse name as an argument and again setting the file paths as detailed in the comments.
The script 'processAll' can also be used to run muliple mice through the pipeline.

The output of pipeline is two structures: imaging and behaviour.

The behaviour structure contains information about all the behaviour not aquired during imaging.

The imaging structure contains information about both imaging (fluoresence etc) and the behaviour (session_behaviour) that was recorded during that imaging session. 


## Data format in imaging structure:

### Behavioural data (session_behaviour)

The timestamps of all behavioural data is normalised to the start of the imaging and has the unit of FRAMES.
So the timestamp refers to the imaging frame at which the behavioural event occured.

The trial events (e.g. correct_trials) are printed about 4-5 seconds after trial onset. Hence the time of these events is probably not very informative. Use trialType instead.

session_behaviour contains the following fields:

* correct_trials: The frames that correct_trial was printed
* missed_trials: The frames that missed_trial was printed 
* falsepositive_trials: The frames that the falsepositive_trial was printed 
* correctrejection_trials: The frames that correctrejection_trial was printed 
* licks: The frames that a lick event was registered 
* water_delivered: The frames that a water reward was delivered
* running_forward: The frames that a binary running forward event was detected (rotary encoder currently samples at 1Hz
* running_backward: The frames that a a binary running backward event was detected
* motor_start: The frames that the motor started moving forwards. This signals the start of a trial
* initial_trials: The frames that initial_trial was printed. 
* area: The area number that the behaviour and imaging was recorded at
* ID: The name of the mouse on MCMS
* date: The date of the imaging
* sessionType: The type of behaviour occuring during imaging
* session_length: length of the session (ms)
* runEvents: Running events binned (current bin size = 7 seconds) bin size can be changed using the variable 'time_bins' in the running_speed function
* mid_time_bins: The time (seconds) at the centre of the bin
* trialType: This list is where information about the trial outcome (e.g. correct_trial) should be read from. It is an ordered list of trial outcomes, ordered in the same way as motor_start and trialByTrialFlu. So trialType(1) shows the outcome of the trial initiated by motor_start(1) and recorded as trialByTrialFlu(1,:,:). The first 1-3 trials should be called 'initial' this is where the animal does not have to induce the trial by running and is automatically rewarded regardless of behaviour.

### Imaging data (planeN)

The result of the 2p imaging generated by suite2p, containing the following fields:

* raw_fluoresence: a 1x1 cell containing a matrix of dimensionality (nROIS x nFrames). This does not take into account work on the GUI, so many of the ROIs may not be cells. Contains the fluoresence signal before neuropil subtraction and DFoF.
* raw_neuropil: same as above but the fluoresence signal from the neuropil surrounding the ROI.
* spike_timings: Contains only ROI selected as cells in the GUI (refered to herein as units). A cell of dimensionality (nUnits x 1). Each index of the cell contains a matrix of dimensionality (nSpikes x 1). Each item in these matrices is the frame that a spike occured in that given unit.
* spike_amps: same as above, but the amplitude of the corresponding spike
* fluoresence_corrected: a matrix of dimensionality (nUnits x nFrames). Contains the corrected fluoresence signal (neuropil subtracted and DFoF) from each unit at each frame.
* position: a matrix of dimensionality (nUnits x 2). The xy coordinates of each unit.
* is_red: whether or not each unit also gives a signal in the red channel (if present)
* fRate: the frame rate at planeN
* trialByTrialFlu: a matrix of dimensionality (nTrials x nUnits x nFrames). The same as fluoresence_corrected by now split by trial. Currently a trial is 4 seconds long. Beginning 1 second before the onset of whisker stimulation and ending 3 seconds after whisker stimualtion. The trial length and offset from whisker stim can be set using the variables tBefore and tAfter.  
* trialByTrialSpikes: a cell of dimensionality (nUnits x nTrials). Each item in the cell is a matrix containing the frame of each trial that a spike occured. Times are normalised to the start of a trial so all spike times range between 0 and the number of frames in a trial.
* trialBytrialAmps: as above but the amplitudes of corresponding spikes.
* info: a note to keep Friedemann sane















































